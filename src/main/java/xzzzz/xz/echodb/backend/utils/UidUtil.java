package xzzzz.xz.echodb.backend.utils;

public class UidUtil {

    /**
     * å°† pgnoã€offset è½¬åŒ–ä¸º uid
     * |------ é«˜ 32 ä½ pgno ------|-- ä¸­é—´ 16 ä½ï¼ˆä¿ç•™ï¼‰ --|-- ä½ 16 ä½ offset --|
     * |      é¡µå·ï¼ˆPage Numberï¼‰  |        ä¿ç•™å­—æ®µ        |     é¡µå†…åç§»é‡       |
     */
    public static long parseToUid(int pgno, short offset) {
        long u0 = pgno;  // å·¦ç§» 32 ä½ â†’ æ”¾åˆ°é«˜ä½
        long u1 = offset;
        return u0 << 32 | u1;
    }

    /**
     * å°è£… pgno + offset çš„ç»“æ„ä½“
     */
    public static class UidInfo {
        private final int pgno;
        private final short offset;

        public UidInfo(int pgno, short offset) {
            this.pgno = pgno;
            this.offset = offset;
        }

        public int getPgno() {
            return this.pgno;
        }

        public short getOffset() {
            return this.offset;
        }
    }

    /**
     * è§£æ uid ä¸º UidInfoï¼ˆpgno + offsetï¼‰
     */
    public static UidInfo parseUid(long uid) {
        // 1L << 16 = 0x0001_0000 = 65536
        // 65536 - 1 = 65535 = 0x0000_FFFF
        // (uid & 0xFFFF)ï¼šåªä¿ç•™ä½ 16 ä½ï¼Œå…¶ä»–å…¨éƒ¨ç½® 0
        short offset = (short) (uid & ((1L << 16) - 1));
        // è¿ç®—ç¬¦	åç§°	        å«ä¹‰                              ç¬¦å·ä½æ˜¯å¦ä¿ç•™	å·¦è¾¹è¡¥ä»€ä¹ˆï¼Ÿ	ç»“æœå¯èƒ½æ˜¯è´Ÿæ•°å—ï¼Ÿ
        // <<	    å·¦ç§»	        æ‰€æœ‰ä½å‘å·¦ç§»åŠ¨ï¼Œå³è¾¹è¡¥ 0              ä¸ç®¡ç¬¦å·	    å³ç§»è¡¥ 0	    âœ… å–å†³äºåŸæ•°
        // >>>	    æ— ç¬¦å·å³ç§»	æ‰€æœ‰ä½å‘å³ç§»åŠ¨ï¼Œå·¦è¾¹è¡¥ 0              âŒ ä¸ç®¡ç¬¦å·	å¼ºåˆ¶è¡¥ 0	    âŒï¼ˆä¸€å®šå˜æˆæ­£æ•°ï¼‰
        // >>	    æœ‰ç¬¦å·å³ç§»	æ‰€æœ‰ä½å‘å³ç§»åŠ¨ï¼Œå·¦è¾¹è¡¥ç¬¦å·ä½ï¼ˆ0 æˆ– 1ï¼‰  âœ… ä¿ç•™ç¬¦å·ä½	è¡¥åŸæ¥çš„ç¬¦å·	âœ…ï¼ˆå¸¸ç”¨äºæœ‰ç¬¦å·è¿ç®—ï¼‰
        // ğŸ”¹ << æ˜¯å¾€å·¦æŒªï¼Œå€¼å˜å¤§ï¼ˆä¹˜æ³•ï¼‰
        // ğŸ”¹ >> æ˜¯å¸¦ç¬¦å·å¾€å³æŒªï¼ˆé™¤æ³•ï¼Œä¿ç¬¦å·ï¼‰
        // ğŸ”¹ >>> æ˜¯ä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€ï¼Œå³è¾¹æŒªå®Œå·¦è¾¹è¡¥ 0ï¼ˆåªèƒ½æ­£æ•°ï¼‰
        // ğŸ”¹ <<< æ˜¯éæ³•è¿ç®—ç¬¦ï¼Œä¸å­˜åœ¨
        /*
            1. << å·¦ç§»ï¼ˆå·¦è¾¹ä¸¢æ‰ï¼Œå³è¾¹è¡¥0ï¼‰
            int x = 3;           // äºŒè¿›åˆ¶ 00000000_00000000_00000000_00000011
            int y = x << 2;      //          => 00000000_00000000_00000000_00001100 = 12
            ç›¸å½“äº x * 2^2 = 3 * 4 = 12

            2. >> æœ‰ç¬¦å·å³ç§»ï¼ˆä¿ç•™ç¬¦å·ä½ï¼‰
            int x = -8;          // äºŒè¿›åˆ¶ï¼š11111111_11111111_11111111_11111000
            int y = x >> 2;      //          => 11111111_11111111_11111111_11111110 = -2
            å·¦è¾¹è¡¥çš„æ˜¯ ç¬¦å·ä½ï¼ˆ1ï¼‰ï¼Œå› ä¸ºæ˜¯è´Ÿæ•°ï¼Œä¿æŒè´Ÿæ•°ç‰¹æ€§ã€‚

            3. >>> æ— ç¬¦å·å³ç§»ï¼ˆå§‹ç»ˆè¡¥0ï¼‰
            int x = -8;          // äºŒè¿›åˆ¶ï¼š11111111_11111111_11111111_11111000
            int y = x >>> 2;     //          => 00111111_11111111_11111111_11111110ï¼ˆæ­£æ•°ï¼ï¼‰
            å·¦è¾¹å¼ºåˆ¶è¡¥ 0ï¼Œç»“æœä¼šå˜æˆä¸€ä¸ªéå¸¸å¤§çš„æ­£æ•´æ•°ã€‚
         */
        uid >>>= 32;  // ä¸¢æ‰ä½ 32 ä½ï¼Œåªç•™ä¸‹é«˜ 32 ä½
        int pgno = (int) (uid & ((1L << 32) - 1));  // è™½ç„¶å³ç§»å®Œå·²ç»æ˜¯ 32 ä½äº†ï¼Œä½†ä¸ºäº†å®‰å…¨/è¯­ä¹‰æ¸…æ™°ï¼Œå®ƒå†ç”¨ & 0xFFFFFFFF åªä¿ç•™ä½ 32 ä½
        return new UidInfo(pgno, offset);
    }
}
